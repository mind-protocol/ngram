protocol: investigate
version: "1.1"
description: Deep dive into an issue, gather evidence, and determine next steps (resolve, escalate, or capture decision)

triggers:
  - gap: "Stuck module with no activity"
  - gap: "Unresolved escalation in graph"
  - event: "Doctor detects issue needing investigation"
  - event: "Decision blocking progress"

requires_skills:
  - SKILL_Debug_Investigate_And_Fix_Issues_With_Evidence_First.md

contextual_knowledge:
  domain: |
    Investigation in ngram:
    - Evidence-first: gather facts before proposing solutions
    - Investigation moment = traceable record of what was examined
    - Outcomes: resolve (fix it), escalate (need help), capture_decision (choose path)
    - Escalations link to affected nodes via `about` relationship
    Structure:
    - Investigation → explores issue
    - Escalation → flags blocker needing external input
    - Decision → records choice with rationale and alternatives
  constraints: |
    - Must gather evidence before concluding
    - Never propose solution without understanding problem
    - If blocked, escalate with clear context and options
    - Decisions must capture alternatives considered
  dependencies: |
    - Issue must be identifiable (node, space, or description)
    - Enables: escalation resolution, decision capture, blocker removal
  quality_criteria: |
    Good investigation: "Examined call_protocol implementation. Found: step returns $call_protocol but runner doesn't handle it. Evidence: runner.py:45 has no case for this. Options: (A) add handler to runner, (B) change step return format."
    Bad investigation: "Looked at the code, seems broken."

steps:
  identify_issue:
    type: ask
    context: |
      Investigation starts by clearly identifying what needs to be understood.
      Be specific about the issue scope and symptoms.
    questions:
      - name: issue_type
        ask: "What type of issue? (bug / stuck_module / escalation / decision_needed / unclear_behavior)"
        why_it_matters: "Guides investigation approach"
        expects:
          type: enum
          options: [bug, stuck_module, escalation, decision_needed, unclear_behavior]
      - name: issue_description
        ask: "Describe the issue in detail"
        why_it_matters: "Defines investigation scope"
        good_answer: "call_protocol step executes but runner doesn't transition to sub-protocol. Session context shows call_stack populated but current_step unchanged."
        bad_answer: "Something's broken"
        expects:
          type: string
          min_length: 30
      - name: affected_space
        ask: "Which space/module is affected?"
        why_it_matters: "Links investigation to correct area"
        expects:
          type: id
          node_type: space
      - name: affected_nodes
        ask: "Which specific nodes are involved? (empty if general issue)"
        expects:
          type: id_list
          optional: true
    moment:
      agent_provides: [description]
    next: load_context

  load_context:
    type: query
    auto_fetch:
      - query:
          find: escalation
          about: "{affected_space}"
          where:
            status: open
        store_as: open_escalations
      - query:
          find: moment
          about: "{affected_space}"
          limit: 10
        store_as: recent_activity
      - query:
          find: narrative
          type: decision
          in_space: "{affected_space}"
          limit: 5
        store_as: related_decisions
    purpose: "Load existing escalations, recent activity, and related decisions"
    next: gather_evidence

  gather_evidence:
    type: ask
    context: |
      {contextual_knowledge.domain}

      Issue: {issue_type} - {issue_description}
      Affected space: {affected_space}
      Open escalations: {open_escalations | list}
      Recent activity: {recent_activity | summarize}
      Related decisions: {related_decisions | list}
    questions:
      - name: evidence_gathered
        ask: "What evidence did you find? (facts, observations, logs, code locations)"
        why_it_matters: "Foundation for conclusions"
        good_answer: "1. runner.py:45 - _process_current_step has no case for '$call_protocol' return. 2. session.py:78 - call_stack correctly populated. 3. Test failure: test_call_protocol times out waiting for sub-protocol start."
        bad_answer: "Checked some files"
        expects:
          type: string
          min_length: 50
      - name: root_cause
        ask: "What appears to be the root cause? (hypothesis based on evidence)"
        why_it_matters: "Guides solution approach"
        expects:
          type: string
          min_length: 20
      - name: options
        ask: "What are the possible paths forward? (list 2-4 options)"
        why_it_matters: "Shows alternatives considered"
        good_answer: "A) Add $call_protocol handler to runner that starts sub-protocol. B) Change step to directly start sub-protocol. C) Refactor to use async/await pattern for sub-protocols."
        bad_answer: "Fix it"
        expects:
          type: string
          min_length: 30
    moment:
      agent_provides: [description, reasoning]
    next: determine_outcome

  determine_outcome:
    type: ask
    context: |
      Evidence: {evidence_gathered}
      Root cause: {root_cause}
      Options: {options}
    questions:
      - name: outcome_type
        ask: "What's the outcome? (can_resolve / needs_escalation / needs_decision)"
        why_it_matters: "Determines next protocol to call"
        expects:
          type: enum
          options: [can_resolve, needs_escalation, needs_decision]
      - name: recommendation
        ask: "If resolvable, what's your recommended fix? If escalation/decision, what input is needed?"
        why_it_matters: "Provides actionable next step"
        expects:
          type: string
          min_length: 20
    moment:
      agent_provides: [description]
    next: gather_thoughts

  gather_thoughts:
    type: ask
    context: |
      ## Protocol Reflection

      Before recording the investigation outcome, share any thoughts on this protocol.
      Your feedback helps improve future executions.

    questions:
      - name: protocol_thoughts
        ask: "Any thoughts or suggestions on how to improve this investigate protocol?"
        why_it_matters: "Continuous improvement through reflection"
        good_answer: "Could auto-fetch related test failures and error logs based on affected_space to provide more context during evidence gathering."
        expects:
          type: string
          required: false

      - name: context_observations
        ask: "Anything about the context or process that could be better?"
        expects:
          type: string
          required: false

    next: route_outcome

  route_outcome:
    type: branch
    checks:
      - condition: "{outcome_type} == 'needs_escalation'"
        action:
          goto: create_escalation
      - condition: "{outcome_type} == 'needs_decision'"
        action:
          goto: create_decision
      - condition: "{outcome_type} == 'can_resolve'"
        action:
          goto: create_investigation_moment

  create_escalation:
    type: create
    nodes:
      # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
      # NODE: Escalation (Blocker)
      # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
      - id: "escalation_{affected_space}_{timestamp}"
        node_type: escalation
        status: open
        issue_type: "{issue_type}"
        description: "{issue_description}"
        evidence: "{evidence_gathered}"
        root_cause: "{root_cause}"
        options: "{options}"
        input_needed: "{recommendation}"
        # ━━━ ATTRIBUTE EXPLANATIONS ━━━
        #
        # id: "escalation_{affected_space}_{timestamp}"
        #   WHAT: Unique ID for this escalation
        #   WHY: Enables tracking and resolution of blockers
        #   FORMAT: escalation_<space>_<timestamp>
        #
        # node_type: escalation
        #   WHAT: Specialized node for blocking issues
        #   WHY: Flags items needing external input or decisions
        #   CONTRAST: moments record events, escalations block progress
        #
        # status: open
        #   WHAT: Current state of escalation
        #   WHY: Tracks whether blocker is resolved
        #   OPTIONS: open, in_review, resolved, dismissed
        #
        # issue_type: "{issue_type}"
        #   WHAT: Category of the blocking issue
        #   WHY: Helps route escalations to appropriate handlers
        #   OPTIONS: bug, stuck_module, escalation, decision_needed, unclear_behavior
        #
        # evidence: "{evidence_gathered}"
        #   WHAT: Facts and observations supporting the escalation
        #   WHY: Provides context for resolution without re-investigation
        #   FORMAT: Specific locations, logs, test results
        #
        # root_cause: "{root_cause}"
        #   WHAT: Hypothesis about underlying issue
        #   WHY: Guides resolution approach
        #   CONFIDENCE: May be uncertain, marked as hypothesis
        #
        # options: "{options}"
        #   WHAT: Possible resolution paths
        #   WHY: Shows alternatives considered, enables informed decision
        #   FORMAT: Enumerated list (A, B, C)
        #
        # input_needed: "{recommendation}"
        #   WHAT: Specific decision or information required
        #   WHY: Makes escalation actionable
        #   FORMAT: Clear question or request

      # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
      # NODE: Moment (Investigation Record)
      # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
      - id: "moment_investigate_{affected_space}_{timestamp}"
        node_type: moment
        prose: |
          ## Investigation: {affected_space}

          **Issue:** {issue_type} - {issue_description}

          **Evidence:**
          {evidence_gathered}

          **Root cause hypothesis:**
          {root_cause}

          **Outcome:** Escalated - needs external input

          **Input needed:**
          {recommendation}
        status: completed
        # ━━━ ATTRIBUTE EXPLANATIONS ━━━
        #
        # id: "moment_investigate_{affected_space}_{timestamp}"
        #   WHAT: Unique ID for this investigation
        #   WHY: Creates traceable record of investigation process
        #   FORMAT: moment_investigate_<space>_<timestamp>
        #
        # node_type: moment
        #   WHAT: Point-in-time event record
        #   WHY: Captures investigation findings at specific time
        #   USE: History and audit trail
        #
        # prose: "## Investigation..."
        #   WHAT: Structured investigation report
        #   WHY: Documents what was found and why escalated
        #   FORMAT: Issue, Evidence, Root cause, Outcome
        #
        # status: completed
        #   WHAT: Moment completion state
        #   WHY: "completed" = investigation finished
        #   OPTIONS: completed, spoken, internal, pending
    links:
      # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
      # LINK: Escalation About Space
      # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
      - type: about
        from: "escalation_{affected_space}_{timestamp}"
        to: "{affected_space}"
        # ━━━ LINK EXPLANATION ━━━
        #
        # type: about
        #   WHAT: Topic/subject relationship
        #   WHY: Links escalation to affected space
        #   QUERY: "What escalations exist for space X?" follows about
        #   DIRECTION: from=escalation, to=space

      # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
      # LINK: Escalation About Nodes
      # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
      - for_each: affected_nodes
        type: about
        from: "escalation_{affected_space}_{timestamp}"
        to: "{item}"
        # ━━━ LINK EXPLANATION ━━━
        #
        # type: about
        #   WHAT: Links escalation to specific affected nodes
        #   WHY: Provides fine-grained context for blockers
        #   CARDINALITY: One-to-many (one escalation, multiple nodes)

      # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
      # LINK: Moment About Space
      # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
      - type: about
        from: "moment_investigate_{affected_space}_{timestamp}"
        to: "{affected_space}"
        # ━━━ LINK EXPLANATION ━━━
        #
        # type: about
        #   WHAT: Links investigation to space
        #   WHY: Makes investigation discoverable from space context
        #   QUERY: "What investigations happened?" follows about

      # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
      # LINK: Actor Expresses Moment
      # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
      - type: expresses
        from: "{actor_id}"
        to: "moment_investigate_{affected_space}_{timestamp}"
        # ━━━ LINK EXPLANATION ━━━
        #
        # type: expresses
        #   WHAT: Attribution link
        #   WHY: Records who performed investigation
        #   QUERY: "What did agent X investigate?" follows expresses
        #   DIRECTION: from=actor, to=moment

      # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
      # LINK: Moment Triggers Escalation
      # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
      - type: triggers
        from: "moment_investigate_{affected_space}_{timestamp}"
        to: "escalation_{affected_space}_{timestamp}"
        # ━━━ LINK EXPLANATION ━━━
        #
        # type: triggers
        #   WHAT: Causal relationship
        #   WHY: Shows investigation led to escalation
        #   QUERY: "What caused this escalation?" follows triggers backward
        #   DIRECTION: from=moment, to=escalation (moment creates escalation)
    moment:
      agent_provides: [description]
    next: call_handoff

  create_decision:
    type: create
    nodes:
      # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
      # NODE: Decision Narrative
      # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
      - id: "decision_{affected_space}_{timestamp}"
        node_type: narrative
        type: decision
        status: pending
        question: "{issue_description}"
        context: "{evidence_gathered}"
        options: "{options}"
        recommendation: "{recommendation}"
        # ━━━ ATTRIBUTE EXPLANATIONS ━━━
        #
        # id: "decision_{affected_space}_{timestamp}"
        #   WHAT: Unique ID for this decision point
        #   WHY: Enables tracking and referencing decisions
        #   FORMAT: decision_<space>_<timestamp>
        #
        # node_type: narrative
        #   WHAT: Persistent knowledge node
        #   WHY: Decisions are part of design history
        #   CONTRAST: moments are events, narratives are lasting knowledge
        #
        # type: decision
        #   WHAT: Subtype of narrative
        #   WHY: Distinguishes from objectives, patterns, etc.
        #   SIBLINGS: objective, pattern, behavior, validation
        #
        # status: pending
        #   WHAT: Decision state
        #   WHY: Tracks whether choice has been made
        #   OPTIONS: pending, made, deferred, obsolete
        #
        # question: "{issue_description}"
        #   WHAT: What needs to be decided
        #   WHY: Frames the decision clearly
        #   FORMAT: Question or choice statement
        #
        # context: "{evidence_gathered}"
        #   WHAT: Evidence informing the decision
        #   WHY: Provides basis for informed choice
        #   SOURCE: Investigation findings
        #
        # options: "{options}"
        #   WHAT: Alternative paths available
        #   WHY: Shows what was considered
        #   FORMAT: Enumerated list with tradeoffs
        #
        # recommendation: "{recommendation}"
        #   WHAT: Suggested path forward
        #   WHY: Agent's analysis of best option
        #   AUTHORITY: Recommendation, not decision (human decides)

      # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
      # NODE: Moment (Investigation Record)
      # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
      - id: "moment_investigate_{affected_space}_{timestamp}"
        node_type: moment
        prose: |
          ## Investigation: {affected_space}

          **Issue:** {issue_type} - {issue_description}

          **Evidence:**
          {evidence_gathered}

          **Root cause hypothesis:**
          {root_cause}

          **Outcome:** Decision needed

          **Decision question:**
          {issue_description}

          **Options:**
          {options}

          **Recommendation:**
          {recommendation}
        status: completed
        # ━━━ ATTRIBUTE EXPLANATIONS ━━━
        #
        # id: "moment_investigate_{affected_space}_{timestamp}"
        #   WHAT: Unique ID for this investigation
        #   WHY: Creates traceable record of investigation
        #   FORMAT: moment_investigate_<space>_<timestamp>
        #
        # node_type: moment
        #   WHAT: Point-in-time event
        #   WHY: Captures when decision point was identified
        #   USE: History and audit trail
        #
        # prose: "## Investigation..."
        #   WHAT: Investigation findings leading to decision
        #   WHY: Documents why decision is needed
        #   FORMAT: Issue, Evidence, Outcome, Decision details
        #
        # status: completed
        #   WHAT: Moment completion state
        #   WHY: "completed" = investigation finished, decision framed
        #   OPTIONS: completed, spoken, internal, pending
    links:
      # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
      # LINK: Space Contains Decision
      # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
      - type: contains
        from: "{affected_space}"
        to: "decision_{affected_space}_{timestamp}"
        # ━━━ LINK EXPLANATION ━━━
        #
        # type: contains
        #   WHAT: Containment relationship
        #   WHY: Decision belongs to space's knowledge
        #   QUERY: "What decisions exist for space X?" follows contains
        #   DIRECTION: from=space, to=decision (space owns decision)

      # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
      # LINK: Moment About Space
      # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
      - type: about
        from: "moment_investigate_{affected_space}_{timestamp}"
        to: "{affected_space}"
        # ━━━ LINK EXPLANATION ━━━
        #
        # type: about
        #   WHAT: Topic/subject relationship
        #   WHY: Links investigation to space
        #   QUERY: "What investigations happened for space X?" follows about
        #   DIRECTION: from=moment, to=space

      # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
      # LINK: Actor Expresses Moment
      # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
      - type: expresses
        from: "{actor_id}"
        to: "moment_investigate_{affected_space}_{timestamp}"
        # ━━━ LINK EXPLANATION ━━━
        #
        # type: expresses
        #   WHAT: Attribution link
        #   WHY: Records who performed investigation
        #   QUERY: "What did agent X investigate?" follows expresses
        #   DIRECTION: from=actor, to=moment

      # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
      # LINK: Moment Proposes Decision
      # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
      - type: proposes
        from: "moment_investigate_{affected_space}_{timestamp}"
        to: "decision_{affected_space}_{timestamp}"
        # ━━━ LINK EXPLANATION ━━━
        #
        # type: proposes
        #   WHAT: Proposal relationship
        #   WHY: Shows investigation led to decision framing
        #   QUERY: "What investigation proposed this decision?" follows proposes backward
        #   DIRECTION: from=moment, to=decision (moment creates decision)
    moment:
      agent_provides: [description]
    next: call_handoff

  create_investigation_moment:
    type: create
    nodes:
      # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
      # NODE: Moment (Investigation with Resolution)
      # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
      - id: "moment_investigate_{affected_space}_{timestamp}"
        node_type: moment
        prose: |
          ## Investigation: {affected_space}

          **Issue:** {issue_type} - {issue_description}

          **Evidence:**
          {evidence_gathered}

          **Root cause hypothesis:**
          {root_cause}

          **Outcome:** Can resolve

          **Recommended fix:**
          {recommendation}

          **Options considered:**
          {options}
        status: completed
        # ━━━ ATTRIBUTE EXPLANATIONS ━━━
        #
        # id: "moment_investigate_{affected_space}_{timestamp}"
        #   WHAT: Unique ID for this investigation
        #   WHY: Creates traceable record
        #   FORMAT: moment_investigate_<space>_<timestamp>
        #
        # node_type: moment
        #   WHAT: Point-in-time event
        #   WHY: Captures investigation that led to resolution
        #   USE: History and learning
        #
        # prose: "## Investigation..."
        #   WHAT: Complete investigation report with resolution
        #   WHY: Documents problem-solving process
        #   FORMAT: Issue, Evidence, Root cause, Resolution, Options
        #   VALUE: Future reference for similar issues
        #
        # status: completed
        #   WHAT: Moment completion state
        #   WHY: "completed" = investigation finished, path forward clear
        #   OPTIONS: completed, spoken, internal, pending
    links:
      # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
      # LINK: Moment About Space
      # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
      - type: about
        from: "moment_investigate_{affected_space}_{timestamp}"
        to: "{affected_space}"
        # ━━━ LINK EXPLANATION ━━━
        #
        # type: about
        #   WHAT: Topic/subject relationship
        #   WHY: Links investigation to space
        #   QUERY: "What investigations happened for space X?" follows about
        #   DIRECTION: from=moment, to=space

      # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
      # LINK: Actor Expresses Moment
      # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
      - type: expresses
        from: "{actor_id}"
        to: "moment_investigate_{affected_space}_{timestamp}"
        # ━━━ LINK EXPLANATION ━━━
        #
        # type: expresses
        #   WHAT: Attribution link
        #   WHY: Records who investigated
        #   QUERY: "What did agent X investigate?" follows expresses
        #   DIRECTION: from=actor, to=moment

      # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
      # LINK: Moment References Affected Nodes
      # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
      - for_each: affected_nodes
        type: references
        from: "moment_investigate_{affected_space}_{timestamp}"
        to: "{item}"
        # ━━━ LINK EXPLANATION ━━━
        #
        # type: references
        #   WHAT: Direct reference to affected nodes
        #   WHY: Links investigation to specific problem nodes
        #   QUERY: "What nodes were investigated?" follows references
        #   DIRECTION: from=moment, to=node
        #   CARDINALITY: One-to-many (one investigation, multiple nodes)
    moment:
      agent_provides: [description]
    next: call_handoff

  call_handoff:
    type: call_protocol
    protocol: completion_handoff
    inputs:
      space_id: "{affected_space}"
      task_id: "investigate_{affected_space}"
    next: $complete

output:
  cluster:
    nodes: [moment_investigate, escalation (conditional), decision (conditional)]
    links: [about, expresses, references, triggers, proposes]
  summary: "Investigated {issue_type} in {affected_space}: {outcome_type}"
  returns:
    outcome_type: "{outcome_type}"
    recommendation: "{recommendation}"
    root_cause: "{root_cause}"
    escalation_id: "escalation_{affected_space}_{timestamp}"
    decision_id: "decision_{affected_space}_{timestamp}"
