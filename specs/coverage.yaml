# Coverage Validation Spec
# Single source of truth for doctor → skill → protocol → output mapping
# See docs/concepts/coverage/ for full documentation

version: "1.0"

doctor_workflow:
  detections:
    # Documentation health
    - id: "D-UNDOC-CODE"
      trigger: "Undocumented code directory"
      category: doc_health
      skill: "ngram.create_module_docs"

    - id: "D-PLACEHOLDER-DOCS"
      trigger: "Placeholder docs ({template})"
      category: doc_health
      skill: "ngram.create_module_docs"

    - id: "D-ORPHAN-DOCS"
      trigger: "Orphaned docs (point to deleted code)"
      category: doc_health
      skill: "ngram.create_module_docs"

    - id: "D-STALE-SYNC"
      trigger: "Stale SYNC (not updated recently)"
      category: doc_health
      skill: "ngram.update_sync"

    - id: "D-INCOMPLETE-CHAIN"
      trigger: "Incomplete doc chain"
      category: doc_health
      skill: "ngram.create_module_docs"

    # Module definition
    - id: "D-NO-MAPPING"
      trigger: "Missing modules.yaml entry"
      category: module_def
      skill: "ngram.module_define_boundaries"

    - id: "D-NO-OBJECTIVES"
      trigger: "Missing OBJECTIVES"
      category: module_def
      skill: "ngram.module_define_boundaries"

    - id: "D-NO-PATTERNS"
      trigger: "Missing PATTERNS"
      category: module_def
      skill: "ngram.module_define_boundaries"

    # Code structure
    - id: "D-MONOLITH"
      trigger: "Monolith file (>500 lines)"
      category: code_struct
      skill: "ngram.implement_with_docs"

    - id: "D-NO-IMPL-DOC"
      trigger: "No IMPLEMENTATION doc"
      category: code_struct
      skill: "ngram.implement_with_docs"

    # Health verification
    - id: "D-NO-HEALTH"
      trigger: "No health indicators for module"
      category: health_ver
      skill: "ngram.health_define_and_verify"

    - id: "D-VALIDATION-NO-HEALTH"
      trigger: "Validation without health check"
      category: health_ver
      skill: "ngram.health_define_and_verify"

    # Escalation management
    - id: "D-STUCK-MODULE"
      trigger: "Stuck module (DESIGNING with no activity)"
      category: escalation
      skill: "ngram.debug_investigate"

    - id: "D-UNRESOLVED-ESC"
      trigger: "Unresolved escalation"
      category: escalation
      skill: "ngram.debug_investigate"

    - id: "D-TODO-ROT"
      trigger: "TODO rot (aging backlog)"
      category: escalation
      skill: "ngram.debug_investigate"

skills:
  # Primitive skill (used by other skills)
  ngram.add_cluster:
    file: "templates/ngram/skills/SKILL_Add_Cluster_Dynamic_Creation.md"
    protocols:
      - add_cluster
    primitive: true  # Not triggered by doctor, used by other protocols

  ngram.create_module_docs:
    file: "templates/ngram/skills/SKILL_Create_Module_Documentation_Chain_From_Templates_And_Seed_Todos.md"
    protocols:
      - explore_space
      - create_doc_chain

  ngram.module_define_boundaries:
    file: "templates/ngram/skills/SKILL_Define_Module_Boundaries_Objectives_And_Scope.md"
    protocols:
      - explore_space
      - define_space
      - add_objectives
      - add_patterns

  ngram.implement_with_docs:
    file: "templates/ngram/skills/SKILL_Implement_Write_Or_Modify_Code_With_Doc_Chain_Coupling.md"
    protocols:
      - explore_space
      - add_implementation
      - record_work

  ngram.health_define_and_verify:
    file: "templates/ngram/skills/SKILL_Define_And_Verify_Health_Signals_Mapped_To_Validation_Invariants.md"
    protocols:
      - explore_space
      - add_invariant
      - add_health_coverage

  ngram.debug_investigate:
    file: "templates/ngram/skills/SKILL_Debug_Investigate_And_Fix_Issues_With_Evidence_First.md"
    protocols:
      - investigate
      - raise_escalation
      - resolve_blocker
      - capture_decision

  ngram.update_sync:
    file: "templates/ngram/skills/SKILL_Update_Module_Sync_State_And_Record_Markers.md"
    protocols:
      - record_work
      - update_sync

protocols:
  # Phase 0: Primitives (IMPLEMENTED)
  add_cluster:
    file: "protocols/add_cluster.yaml"
    phase: 0
    status: implemented
    primitive: true  # Reusable building block
    output_nodes: [any, moment]
    output_links: [contains, relates, attached_to, expresses, about]

  # Phase 1: Core (IMPLEMENTED)
  explore_space:
    file: "protocols/explore_space.yaml"
    phase: 1
    status: implemented
    output_nodes: [moment]
    output_links: [about, expresses]

  record_work:
    file: "protocols/record_work.yaml"
    phase: 1
    status: implemented
    output_nodes: [moment]
    output_links: [about, expresses, references]

  investigate:
    file: "protocols/investigate.yaml"
    phase: 1
    status: implemented
    output_nodes: [moment, escalation, decision]
    output_links: [about, expresses, triggers, proposes]

  # Phase 2: Doc chain (IMPLEMENTED)
  add_objectives:
    file: "protocols/add_objectives.yaml"
    phase: 2
    status: implemented
    output_nodes: [narrative_objective, moment]
    output_links: [contains, supports, bounds]

  add_patterns:
    file: "protocols/add_patterns.yaml"
    phase: 2
    status: implemented
    output_nodes: [narrative_pattern, moment]
    output_links: [contains, achieves, protects]

  update_sync:
    file: "protocols/update_sync.yaml"
    phase: 2
    status: implemented
    output_nodes: [narrative_sync, moment, todo, escalation, proposition]
    output_links: [contains, about, sequence, expresses, supersedes]

  add_behaviors:
    file: "protocols/add_behaviors.yaml"
    phase: 2
    status: implemented
    output_nodes: [narrative_behaviors, moment]
    output_links: [contains, serves, expresses]

  add_algorithm:
    file: "protocols/add_algorithm.yaml"
    phase: 2
    status: implemented
    output_nodes: [narrative_algorithm, moment]
    output_links: [contains, implements, expresses]

  # Phase 3: Verification (IMPLEMENTED)
  add_invariant:
    file: "protocols/add_invariant.yaml"
    phase: 3
    status: implemented
    output_nodes: [narrative_validation, moment]
    output_links: [contains, ensures]

  add_health_coverage:
    file: "protocols/add_health_coverage.yaml"
    phase: 3
    status: implemented
    output_nodes: [narrative_health, thing_dock, moment]
    output_links: [contains, verifies, attached_to]

  add_implementation:
    file: "protocols/add_implementation.yaml"
    phase: 3
    status: implemented
    output_nodes: [narrative_implementation, thing_dock, moment]
    output_links: [contains, expresses]

  # Phase 4: Issue handling (IMPLEMENTED)
  raise_escalation:
    file: "protocols/raise_escalation.yaml"
    phase: 4
    status: implemented
    output_nodes: [escalation, moment]
    output_links: [about, expresses, triggers, sequence]

  resolve_blocker:
    file: "protocols/resolve_blocker.yaml"
    phase: 4
    status: implemented
    output_nodes: [moment, todo]
    output_links: [resolves, expresses, about, spawned_from]

  capture_decision:
    file: "protocols/capture_decision.yaml"
    phase: 4
    status: implemented
    output_nodes: [narrative_decision, moment]
    output_links: [contains, affects, about, expresses]

  # Phase 5: Full coverage (IMPLEMENTED)
  define_space:
    file: "protocols/define_space.yaml"
    phase: 5
    status: implemented
    output_nodes: [space, moment]
    output_links: [expresses, contains]

  create_doc_chain:
    file: "protocols/create_doc_chain.yaml"
    phase: 5
    status: implemented
    output_nodes: [narrative_objectives, narrative_patterns, narrative_sync, moment]
    output_links: [contains, expresses]

  add_goals:
    file: "protocols/add_goals.yaml"
    phase: 5
    status: implemented
    output_nodes: [narrative_goal, moment]
    output_links: [contains, supports, expresses]

  add_todo:
    file: "protocols/add_todo.yaml"
    phase: 5
    status: implemented
    output_nodes: [todo, moment]
    output_links: [about, contains, expresses]
