### docs/connectome/log_panel/PATTERNS_Connectome_Log_Panel_Unified_Explain_And_Copyable_Event_Ledger_View_Patterns.md

$$$

# log_panel — Patterns: Unified Explain + Copyable Event Ledger View

STATUS: DRAFT
CREATED: 2025-12-20
VERIFIED: 2025-12-20 against ?
$$$

---

## CHAIN

$$$
THIS:            PATTERNS_Connectome_Log_Panel_Unified_Explain_And_Copyable_Event_Ledger_View_Patterns.md (you are here)
BEHAVIORS:       ./BEHAVIORS_Connectome_Log_Panel_Step_Clarity_And_Copyable_Audit_Trail_Effects.md
ALGORITHM:       ./ALGORITHM_Connectome_Log_Panel_Log_Rendering_Duration_Coloring_And_Export.md
VALIDATION:      ./VALIDATION_Connectome_Log_Panel_Invariants_For_Truthful_Durations_And_Stable_Export.md
IMPLEMENTATION:  ./IMPLEMENTATION_Connectome_Log_Panel_Component_Structure_And_Serializer_Integration.md
HEALTH:          ./HEALTH_Connectome_Log_Panel_Runtime_Verification_Of_Log_Truth_And_Export_Integrity.md
SYNC:            ./SYNC_Connectome_Log_Panel_Sync_Current_State.md
$$$

### Bidirectional Contract

$$$
Before modifying this doc or the code:

1. Read ALL docs in this chain
2. Read event_model + state_store (log_panel is a projection)

After modifying this doc:

* Update implementation OR record mismatch in SYNC

After modifying the code:

* Update docs OR record mismatch in SYNC

Never degrade:

* copy/export fidelity (export == ledger)
* duration truthfulness and color rules
* “one step = one explanation sentence”
  $$$

---

## THE PROBLEM

/connectome previously had two separate surfaces:

* explanation (“what’s happening now”)
* system log (persistent history)

This split causes drift:

* explanation describes one step while log highlights another
* copying becomes ambiguous (“copy which?”)
* users lose the causal chain

We need one unified panel that is:

* readable and narrative (“what is happening now”)
* auditable and copyable (stable ledger export)
* agent-friendly (colored cues for triggers/call types/durations)

---

## THE PATTERN

**Unified “Now + Ledger” panel.**

One panel contains:

1. **Now** section:

   * step index (“Step 9 of 16” not “#9/16”)
   * one-sentence explanation of the current cycle
   * active focus summary (from→to, label)
2. **Ledger** section:

   * append-only list of normalized FlowEvents
   * per-event badges: trigger, call_type, duration bucket, timestamp
3. **Export** actions:

   * copy as JSONL
   * copy as text (human-friendly)
   * (optional) download file later

Key insight:

> The log panel is the “truth window” of /connectome.
> If it lies or drifts, the entire dashboard becomes decoration.

---

## PRINCIPLES

### Principle 1: Render only from the store ledger

No component-maintained shadow logs.
Everything is derived from `state_store.ledger`.

### Principle 2: Duration coloring is deterministic and meaningful

User asked for:

* duration in logs blue if ms
* green if <1s
* yellow <2s
* orange <3s
* red otherwise

This must be enforced centrally.

### Principle 3: Trigger and call type are visibly encoded in log

Log must show:

* trigger type badge colored per trigger kind
* call_type badge colored per palette (yellow/orange/purple/blue/green)

### Principle 4: Export is stable and copy-pasteable

Export must:

* preserve event ids
* preserve order
* preserve required fields
* include session_id boundaries (policy from state_store)

---

## DATA

| Data                         | Source                                    |
| ---------------------------- | ----------------------------------------- |
| current step index           | state_store cursor / active ledger length |
| current explanation sentence | state_store.current_explanation           |
| active focus                 | state_store.active_focus                  |
| ledger events                | state_store.ledger                        |
| health badges                | state_store.health_badges                 |

---

## DEPENDENCIES

| Module           | Why                                           |
| ---------------- | --------------------------------------------- |
| `state_store`    | single source for ledger and explanation      |
| `event_model`    | FlowEvent schema drives formatting            |
| `runtime_engine` | step index semantics                          |
| `flow_canvas`    | may provide hover selection events (optional) |

---

## SCOPE

### In Scope

* unified panel layout: Now + Ledger + Export
* duration formatting and color rules
* trigger/call_type badge coloring
* copy/export functions (integration with state_store serializer)
* “Step X of Y” semantics and end-of-script messaging

### Out of Scope

* node/edge rendering (flow_canvas, node_kit, edge_kit)
* event normalization (event_model)
* ledger storage (state_store)
* health checks for backend invariants (not owned here)

---

## GAPS / IDEAS / QUESTIONS

* [ ] Decide whether export includes raw_payload by default (recommended: no; behind debug toggle).
* QUESTION: Should log be filterable by zone/node/call_type in v1? (nice-to-have, likely v1.1)

---

---

### docs/connectome/log_panel/BEHAVIORS_Connectome_Log_Panel_Step_Clarity_And_Copyable_Audit_Trail_Effects.md

$$$

# log_panel — Behaviors: Step Clarity and Copyable Audit Trail

STATUS: DRAFT
CREATED: 2025-12-20
VERIFIED: 2025-12-20 against ?
$$$

---

## CHAIN

$$$
PATTERNS:        ./PATTERNS_Connectome_Log_Panel_Unified_Explain_And_Copyable_Event_Ledger_View_Patterns.md
THIS:            BEHAVIORS_Connectome_Log_Panel_Step_Clarity_And_Copyable_Audit_Trail_Effects.md (you are here)
ALGORITHM:       ./ALGORITHM_Connectome_Log_Panel_Log_Rendering_Duration_Coloring_And_Export.md
VALIDATION:      ./VALIDATION_Connectome_Log_Panel_Invariants_For_Truthful_Durations_And_Stable_Export.md
IMPLEMENTATION:  ./IMPLEMENTATION_Connectome_Log_Panel_Component_Structure_And_Serializer_Integration.md
HEALTH:          ./HEALTH_Connectome_Log_Panel_Runtime_Verification_Of_Log_Truth_And_Export_Integrity.md
SYNC:            ./SYNC_Connectome_Log_Panel_Sync_Current_State.md
$$$

---

## BEHAVIORS

### B1: One step has one explanation sentence, always in sync

$$$
GIVEN:  a step is released
THEN:   the “Now” sentence updates exactly once
AND:    it matches the most recent ledger event
AND:    the active focus shown in the panel matches the active edge glow
$$$

### B2: “Step X of Y” is always readable and unambiguous

$$$
GIVEN:  ledger has N entries and step script has total T (if known)
THEN:   the panel displays “Step (cursor) of (T)” (or “Step (cursor)” if T unknown)
AND:    never displays ambiguous shorthand like “#9/16”
$$$

### B3: Duration coloring communicates severity at a glance

$$$
GIVEN:  a duration exists
THEN:   duration text is color-coded:
ms: blue
<1s: green
<2s: yellow
<3s: orange
else: red
$$$

### B4: Trigger types are visibly distinct in the log

$$$
GIVEN:  trigger is direct/stream/async/hook/timer
THEN:   a trigger badge uses distinct colors (deterministic palette)
$$$

### B5: Export is copy/paste reliable

$$$
GIVEN:  user clicks “Copy log”
THEN:   clipboard contains a stable representation of the ledger
AND:    user can paste it back into tools to replay/debug
$$$

---

## ANTI-BEHAVIORS

### A1: Log line lies about what happened

$$$
MUST NOT: display an explanation that doesn’t correspond to the last event
INSTEAD: explanation is derived from the last released FlowEvent
$$$

### A2: Export does not match ledger

$$$
MUST NOT: export a filtered/partial list without telling the user
INSTEAD: export indicates filters, or exports full ledger by default
$$$

---

## EDGE CASES

### E1: Unknown duration

$$$
GIVEN:  duration is unknown
THEN:   display “?” with muted styling
AND:    show notes in tooltip
$$$

### E2: Realtime bursts (deferred)

$$$
GIVEN:  realtime emits many events
THEN:   log remains usable with retention/pagination policy (owned by state_store)
$$$

---

## GAPS / IDEAS / QUESTIONS

* QUESTION: Should duration thresholds be configurable? (v1: no, fixed)
* IDEA: Provide a “copy last 20” option in v1.1

---

---

### docs/connectome/log_panel/ALGORITHM_Connectome_Log_Panel_Log_Rendering_Duration_Coloring_And_Export.md

$$$

# log_panel — Algorithm: Rendering, Duration Coloring, Trigger Badges, and Export

STATUS: DRAFT
CREATED: 2025-12-20
VERIFIED: 2025-12-20 against ?
$$$

---

## CHAIN

$$$
PATTERNS:        ./PATTERNS_Connectome_Log_Panel_Unified_Explain_And_Copyable_Event_Ledger_View_Patterns.md
BEHAVIORS:       ./BEHAVIORS_Connectome_Log_Panel_Step_Clarity_And_Copyable_Audit_Trail_Effects.md
THIS:            ALGORITHM_Connectome_Log_Panel_Log_Rendering_Duration_Coloring_And_Export.md (you are here)
VALIDATION:      ./VALIDATION_Connectome_Log_Panel_Invariants_For_Truthful_Durations_And_Stable_Export.md
IMPLEMENTATION:  ./IMPLEMENTATION_Connectome_Log_Panel_Component_Structure_And_Serializer_Integration.md
HEALTH:          ./HEALTH_Connectome_Log_Panel_Runtime_Verification_Of_Log_Truth_And_Export_Integrity.md
SYNC:            ./SYNC_Connectome_Log_Panel_Sync_Current_State.md
$$$

---

## OVERVIEW

log_panel is a pure projection:

Inputs:

* store.ledger (FlowEvent[])
* store.current_explanation
* store.active_focus
* store.cursor + optional script_total
* store.health_badges

Outputs:

* Now section content
* Ledger list UI
* Export actions

---

## ALGORITHM: `render_now_section(store_state)`

1. Determine step index:

* step_index = store.cursor (or ledger length)
* step_total = runtime_engine script total if known else `?`

2. Determine current event:

* current_event = last element of ledger OR null

3. Render:

* Step label: “Step X of Y” (if Y known) else “Step X”
* Explanation sentence:

  * store.current_explanation.sentence
  * if missing: derive from current_event label/from/to else “?”

4. Render focus summary:

* “Active: from → to : label”
* badges for trigger + call_type

---

## ALGORITHM: `render_ledger_list(store_state)`

For each event e in ledger:

* render header row:

  * timestamp (or at_ms formatted)
  * trigger badge (colored)
  * call_type badge (colored)
  * duration field (colored by thresholds)
* render body:

  * label text (not bold)
  * payload_summary (if present)
  * rate_hint (if present)
  * notes (if “?”)

---

## ALGORITHM: duration formatting and coloring

### `format_duration_text(duration_ms)`

* if undefined: return “?”
* if <1000: return `${ms}ms`
* else: return `${(ms/1000).toFixed(2)}s`

### `duration_color_class(duration_ms)`

User rules:

$$$
IF duration_ms is undefined:
class = muted
ELSE IF duration_ms < 1000:
class = blue
ELSE IF duration_ms < 2000:
class = yellow
ELSE IF duration_ms < 3000:
class = orange
ELSE:
class = red
AND:
NOTE: <1s is “green” by severity, but user explicitly wants ms in blue.
Therefore:
duration_ms < 1000 => blue (unit-driven override)
$$$

Trigger badge colors (deterministic palette):

$$$
direct => blue-ish badge
stream => cyan-ish badge
async  => purple-ish badge
hook   => grey/teal badge (?)
timer  => grey/orange badge (?)
$$$

---

## ALGORITHM: export

### Export JSONL

* one JSON object per line
* includes session_id header line optionally:

  * `{"type":"session","session_id":"...","started_at_ms":...}`
* then events in order

### Export Text

* stable human-friendly lines:

  * `[tstamp] [trigger] [call_type] [duration] from→to label — payload_summary — rate_hint — notes`

Export must be derived from ledger only (no UI-only state).

---

## COMPLEXITY

* rendering: O(n)
* export: O(n)

---

## GAPS / IDEAS / QUESTIONS

* QUESTION: Should export include cursor and speed changes as synthetic events? (nice-to-have; possibly represented as call_type=code)

---

---

### docs/connectome/log_panel/VALIDATION_Connectome_Log_Panel_Invariants_For_Truthful_Durations_And_Stable_Export.md

$$$

# log_panel — Validation: Invariants for Truthful Durations and Stable Export

STATUS: DRAFT
CREATED: 2025-12-20
VERIFIED: 2025-12-20 against ?
$$$

---

## CHAIN

$$$
PATTERNS:        ./PATTERNS_Connectome_Log_Panel_Unified_Explain_And_Copyable_Event_Ledger_View_Patterns.md
BEHAVIORS:       ./BEHAVIORS_Connectome_Log_Panel_Step_Clarity_And_Copyable_Audit_Trail_Effects.md
ALGORITHM:       ./ALGORITHM_Connectome_Log_Panel_Log_Rendering_Duration_Coloring_And_Export.md
THIS:            VALIDATION_Connectome_Log_Panel_Invariants_For_Truthful_Durations_And_Stable_Export.md (you are here)
IMPLEMENTATION:  ./IMPLEMENTATION_Connectome_Log_Panel_Component_Structure_And_Serializer_Integration.md
HEALTH:          ./HEALTH_Connectome_Log_Panel_Runtime_Verification_Of_Log_Truth_And_Export_Integrity.md
SYNC:            ./SYNC_Connectome_Log_Panel_Sync_Current_State.md
$$$

---

## INVARIANTS

### V1: Explanation matches last event

$$$
If ledger non-empty:
Now.explanation corresponds to last ledger event (same id or derived from it)
$$$

### V2: “Step X of Y” formatting is unambiguous

$$$
Panel never shows shorthand like "#9/16"
It shows "Step X of Y" or "Step X" only
$$$

### V3: Duration color mapping matches rules

$$$
duration_ms undefined => muted
duration_ms < 1000    => blue
duration_ms < 2000    => yellow
duration_ms < 3000    => orange
duration_ms >= 3000   => red
$$$

### V4: Export equals ledger

$$$
Export JSONL contains all ledger events in order (plus optional session header)
Export Text contains all ledger events in order (plus optional session header)
$$$

---

## ERROR CONDITIONS

### E1: Export mismatch

* severity: ERROR
* meaning: copy/paste debugging is broken

### E2: Duration colored incorrectly

* severity: WARN/ERROR depending on frequency
* meaning: log cannot be trusted for performance intuition

---

## HEALTH COVERAGE

| Validation | Health Indicator                     |
| ---------- | ------------------------------------ |
| V1         | log_now_matches_last_event_integrity |
| V3         | log_duration_color_mapping_integrity |
| V4         | log_export_equals_ledger_integrity   |

---

## VERIFICATION PROCEDURE

### Manual

$$$
[ ] Step once → Now sentence describes that step
[ ] Look at Step indicator → “Step X of Y” (no shorthand)
[ ] Confirm ms durations appear blue
[ ] Copy JSONL and paste: event count equals ledger count
$$$

### Automated

$$$
pnpm connectome:health log_panel
$$$

---

## GAPS / IDEAS / QUESTIONS

* QUESTION: Should “call_type” also have a badge in export text? (likely yes for readability)

---

---

### docs/connectome/log_panel/HEALTH_Connectome_Log_Panel_Runtime_Verification_Of_Log_Truth_And_Export_Integrity.md

$$$

# log_panel — Health: Verification of Log Truth and Export Integrity

STATUS: DRAFT
CREATED: 2025-12-20
$$$

---

## PURPOSE OF THIS FILE

log_panel HEALTH verifies that:

* Now section corresponds to the last event
* duration coloring follows strict rules
* export equals ledger

This is critical because /connectome is meant for debugging and agent audits.

---

## CHAIN

$$$
PATTERNS:        ./PATTERNS_Connectome_Log_Panel_Unified_Explain_And_Copyable_Event_Ledger_View_Patterns.md
BEHAVIORS:       ./BEHAVIORS_Connectome_Log_Panel_Step_Clarity_And_Copyable_Audit_Trail_Effects.md
ALGORITHM:       ./ALGORITHM_Connectome_Log_Panel_Log_Rendering_Duration_Coloring_And_Export.md
VALIDATION:      ./VALIDATION_Connectome_Log_Panel_Invariants_For_Truthful_Durations_And_Stable_Export.md
IMPLEMENTATION:  ./IMPLEMENTATION_Connectome_Log_Panel_Component_Structure_And_Serializer_Integration.md
THIS:            HEALTH_Connectome_Log_Panel_Runtime_Verification_Of_Log_Truth_And_Export_Integrity.md
SYNC:            ./SYNC_Connectome_Log_Panel_Sync_Current_State.md

IMPL:            ? (planned) scripts/connectome/health/log_panel_health_check_runner.ts
$$$

---

## FLOWS ANALYSIS (TRIGGERS + FREQUENCY)

$$$
flows_analysis:

* flow_id: log_panel_updates_on_step_release
  purpose: ensure Now and ledger stay synchronized
  triggers:

  * type: manual
    source: runtime_engine Next click
    frequency:
    expected_rate: "human driven"
    risks:
  * "Now sentence drift"
  * "wrong step count formatting"

* flow_id: log_panel_export
  purpose: ensure export is exact
  triggers:

  * type: manual
    source: Copy buttons
    frequency:
    expected_rate: "occasional"
    risks:
  * "missing events"
  * "wrong ordering"
    $$$

---

## HEALTH INDICATORS SELECTED

$$$
health_indicators:

* name: log_now_matches_last_event_integrity
  flow_id: log_panel_updates_on_step_release
  priority: high

* name: log_duration_color_mapping_integrity
  flow_id: log_panel_updates_on_step_release
  priority: med

* name: log_export_equals_ledger_integrity
  flow_id: log_panel_export
  priority: high
  $$$

---

## CHECKER INDEX

$$$
checkers:

* name: health_check_now_sentence_corresponds_to_last_ledger_event
  purpose: "V1: Now corresponds to last event id/label."
  status: pending

* name: health_check_duration_color_class_matches_thresholds
  purpose: "V3: duration -> color mapping correct."
  status: pending

* name: health_check_export_contains_all_ledger_events_in_order
  purpose: "V4: export equals ledger."
  status: pending
  $$$

---

## HOW TO RUN

$$$
pnpm connectome:health log_panel
$$$

---

## KNOWN GAPS

* [ ] Needs DOM/test harness or snapshot probe to inspect rendered duration color classes.
* [ ] Export checks require serializer utilities to exist.

---

## GAPS / IDEAS / QUESTIONS

* IDEA: export includes a deterministic header with session_id and schema version.

---

---

### docs/connectome/log_panel/SYNC_Connectome_Log_Panel_Sync_Current_State.md

$$$

# log_panel — Sync: Current State

LAST_UPDATED: 2025-12-20
UPDATED_BY: Marco "Salthand" (agent)
STATUS: DESIGNING
$$$

---

## MATURITY

**Canonical (v1 intent):**

* unified “Now + Ledger” panel
* duration coloring rules exactly as specified
* trigger and call_type badges
* copy/export is derived exclusively from store ledger

**In design:**

* filters and search (deferred)
* export format details (session header yes/no)

---

## CURRENT STATE

Docs defined; implementation not started.

Immediate priorities:

* implement panel layout with Now section and ledger list
* implement deterministic duration color rules
* implement copy/export buttons integrated with store serializers

---

## TODO

* [ ] Implement log_panel TSX component
* [ ] Implement duration formatting + coloring helper
* [ ] Implement export serializers (JSONL + text)
* [ ] Add log_panel health harness

Run:

$$$
pnpm connectome:health log_panel
$$$

---

---

### docs/connectome/log_panel/IMPLEMENTATION_Connectome_Log_Panel_Component_Structure_And_Serializer_Integration.md

$$$

# log_panel — Implementation: Component Structure and Serializer Integration

STATUS: DRAFT
CREATED: 2025-12-20
$$$

---

## CHAIN

$$$
PATTERNS:        ./PATTERNS_Connectome_Log_Panel_Unified_Explain_And_Copyable_Event_Ledger_View_Patterns.md
BEHAVIORS:       ./BEHAVIORS_Connectome_Log_Panel_Step_Clarity_And_Copyable_Audit_Trail_Effects.md
ALGORITHM:       ./ALGORITHM_Connectome_Log_Panel_Log_Rendering_Duration_Coloring_And_Export.md
VALIDATION:      ./VALIDATION_Connectome_Log_Panel_Invariants_For_Truthful_Durations_And_Stable_Export.md
THIS:            IMPLEMENTATION_Connectome_Log_Panel_Component_Structure_And_Serializer_Integration.md
HEALTH:          ./HEALTH_Connectome_Log_Panel_Runtime_Verification_Of_Log_Truth_And_Export_Integrity.md
SYNC:            ./SYNC_Connectome_Log_Panel_Sync_Current_State.md

IMPL:            app/connectome/components/unified_now_and_copyable_ledger_log_panel.tsx (PROPOSED)
$$$

---

## CODE STRUCTURE

$$$
app/
└── connectome/
├── components/
│   ├── unified_now_and_copyable_ledger_log_panel.tsx
│   ├── connectome_log_duration_formatting_and_threshold_color_rules.ts
│   ├── connectome_log_trigger_and_calltype_badge_color_tokens.ts
│   └── connectome_log_export_buttons_using_state_store_serializers.tsx
$$$

### File Responsibilities

| File                                                              | Responsibility              | Key Exports                               |
| ----------------------------------------------------------------- | --------------------------- | ----------------------------------------- |
| `unified_now_and_copyable_ledger_log_panel.tsx`                   | main panel UI               | `LogPanel`                                |
| `connectome_log_duration_formatting_and_threshold_color_rules.ts` | duration text + color class | `formatDuration`, `durationColorClass`    |
| `connectome_log_trigger_and_calltype_badge_color_tokens.ts`       | badge palettes              | `triggerBadgeClass`, `callTypeBadgeClass` |
| `connectome_log_export_buttons_using_state_store_serializers.tsx` | copy/export actions         | `ExportButtons`                           |

---

## ENTRY POINTS

| Entry                       | Trigger                 |
| --------------------------- | ----------------------- |
| `LogPanel()`                | /connectome page render |
| `ExportButtons.copyJsonl()` | copy JSONL              |
| `ExportButtons.copyText()`  | copy text               |

---

## DATA FLOW

$$$
state_store selectors
→ LogPanel renders Now and Ledger
→ ExportButtons serializes ledger and copies to clipboard
$$$

---

## CONFIGURATION

| Config                     | Default                  |
| -------------------------- | ------------------------ |
| `SHOW_RAW_PAYLOAD`         | false                    |
| `MAX_LOG_ENTRIES_RENDERED` | ? (depends on retention) |

---

## BIDIRECTIONAL LINKS

* TSX components reference docs/connectome/log_panel/*
* serialization utilities reference state_store serializer docs

---

## GAPS / IDEAS / QUESTIONS

* [ ] Decide whether “Copy log” copies JSONL by default or offers both (recommend: both buttons).
