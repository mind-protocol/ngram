### docs/connectome/flow_canvas/PATTERNS_Connectome_Flow_Canvas_Pannable_Zoomable_Zoned_System_Map_Rendering_Patterns.md

$$$

# flow_canvas — Patterns: Pannable/Zoomable Zoned Map with Stable Edge Readability

STATUS: DRAFT
CREATED: 2025-12-20
VERIFIED: 2025-12-20 against ?
$$$

---

## CHAIN

$$$
THIS:            PATTERNS_Connectome_Flow_Canvas_Pannable_Zoomable_Zoned_System_Map_Rendering_Patterns.md (you are here)
BEHAVIORS:       ./BEHAVIORS_Connectome_Flow_Canvas_Readable_Stable_Interaction_Effects.md
ALGORITHM:       ./ALGORITHM_Connectome_Flow_Canvas_Layout_Zones_And_Edge_Label_Decluttering.md
VALIDATION:      ./VALIDATION_Connectome_Flow_Canvas_Invariants_For_Readability_And_Stability.md
IMPLEMENTATION:  ./IMPLEMENTATION_Connectome_Flow_Canvas_Code_Structure_With_React_Flow_And_Zones.md
HEALTH:          ./HEALTH_Connectome_Flow_Canvas_Runtime_Verification_Of_Render_Stability_And_Perf_Budgets.md
SYNC:            ./SYNC_Connectome_Flow_Canvas_Sync_Current_State.md
$$$

### Bidirectional Contract

$$$
Before modifying this doc or the code:

1. Read ALL docs in this chain
2. Read event_model + state_store (canvas is a projection)

After modifying this doc:

* Update implementation OR record mismatch in SYNC

After modifying the code:

* Update docs OR record mismatch in SYNC

Never degrade:

* pan/zoom correctness
* edge label readability
* stable rendering (no disappearing edges)
  $$$

---

## THE PROBLEM

The connectome diagram must function as a **debugging instrument**, not a poster.

The current failure modes (already observed):

* edges become unreadable (over-bold, overlapping labels)
* edges “disappear” during step transitions (resize/viewBox race)
* nodes are too close and visually ungrouped
* player vs UI vs hook nodes are not distinguishable
* no pan/zoom means you choose between “readable” and “fits on screen”

We need a canvas pattern that stays readable as complexity increases.

---

## THE PATTERN

**Zoned system map projection with deterministic layout and interactive camera.**

* “Zones” are explicit containers:

  * FRONTEND
  * BACKEND
  * GRAPH
  * AGENTS
* Nodes live inside zones; edges route across zones
* Camera supports:

  * pan
  * zoom
  * fit-to-view
  * reset view

Key insight:

> If the diagram is a projection of a ledger, layout must be stable and predictable.
> Force graphs are great for exploration but bad for deterministic debugging.

---

## PRINCIPLES

### Principle 1: Camera-first (pan/zoom) before layout cleverness

A readable diagram needs:

* space between nodes (no tight packing)
* pan/zoom to inspect without shrinking labels into noise
* “reset camera” to recover orientation

### Principle 2: Deterministic layout (not physics) for the main pipeline

The connectome “main data flow” is a system diagram:

* stable positions help users build mental models
* stepper mode relies on spatial memory

Force layout can exist as a secondary exploration mode later, but v1 should be deterministic.

### Principle 3: Label readability over style bravado

* link titles are NOT bold
* labels must remain readable at 100% zoom and not overwhelm nodes
* label background or halo should ensure contrast against edges

### Principle 4: Rendering stability is a correctness requirement

Edges must not disappear:

* no manual SVG viewBox recompute races
* stable edge objects keyed by id
* camera transforms must not detach edges from nodes

---

## DATA

| Data           | Description                                                              |
| -------------- | ------------------------------------------------------------------------ |
| `nodes[]`      | UI nodes with positions and zone membership                              |
| `edges[]`      | Flow edges derived from FlowEvents (or a base map + active highlighting) |
| `active_focus` | which node/edge is active; glow persists                                 |
| `camera`       | x,y,zoom (view state)                                                    |
| `zones`        | FE/BE/GRAPH/AGENTS rectangles and labels                                 |

---

## DEPENDENCIES

| Module           | Why We Depend On It                                  |
| ---------------- | ---------------------------------------------------- |
| `state_store`    | provides nodes/edges list + active_focus             |
| `runtime_engine` | drives step releases that change active focus        |
| `edge_kit`       | provides edge types and visual components            |
| `node_kit`       | provides node renderers                              |
| `event_model`    | provides callType/trigger semantics used for styling |

---

## INSPIRATIONS

* React Flow / node editor UIs
* trace viewers with stable timelines
* “systems maps” with swimlanes (zones)

---

## SCOPE

### In Scope

* pannable/zoomable canvas camera behavior
* zone containers (visual grouping)
* deterministic layout strategy for v1
* label decluttering strategy (minimal but stable)
* fit-to-view + reset view controls

### Out of Scope

* node and edge styling details (owned by node_kit / edge_kit)
* log/explain panel (owned by log_panel)
* telemetry ingestion (owned by telemetry_adapter)
* health invariants for backend truth (not owned here)

---

## PATTERNS USED (SUB-PATTERNS)

### P1: Zoned containers as “semantic declutter”

Zones reduce cognitive load:

* users can instantly locate FE vs BE vs GRAPH vs AGENTS
* edges crossing zones become meaningful and easier to read

### P2: Stable keying and memoization of graph elements

Nodes and edges must be keyed by stable ids:

* node id: stable module/entity id
* edge id: stable link id (from FlowEvent or base map)

### P3: Layering: edges above nodes (but interaction-friendly)

* edges visually on top (as requested)
* but must still allow node interaction
* solution: edges in a higher visual layer with pointer events carefully controlled

---

## ENTRY POINTS

| Entry                                                         | Purpose                                                  |
| ------------------------------------------------------------- | -------------------------------------------------------- |
| `render_connectome_canvas(nodes, edges, zones, active_focus)` | projection render                                        |
| `set_camera_pan_zoom(new_state)`                              | camera updates                                           |
| `fit_view_to_zones()`                                         | reset/fit                                                |
| `on_node_click(node_id)`                                      | interacts with runtime (player message, pin focus, etc.) |

---

## DATA FLOW AND DOCKING (FLOW-BY-FLOW)

### canvas_renders_store_projection

$$$
flow:
name: canvas_renders_store_projection
purpose: Render stable map from store state.
steps:
- read nodes/edges/zones/active_focus from store selectors
- render zones first
- render nodes and edges with stable keys
- apply active_focus glow persistence
- apply camera transform
docking_points:
- dock_canvas_render_commit (event): used by HEALTH for “no disappearing edges”
$$$

---

## GAPS / IDEAS / QUESTIONS

* [ ] Confirm whether we lock node positions in code or compute via a lightweight layout algorithm (recommended: fixed for v1).
* IDEA: optional “declutter toggle” hides secondary labels until zoom > threshold.
* QUESTION: do we need minimap in v1? (nice-to-have)

---

---

### docs/connectome/flow_canvas/BEHAVIORS_Connectome_Flow_Canvas_Readable_Stable_Interaction_Effects.md

$$$

# flow_canvas — Behaviors: Readability, Stability, and Navigation Effects

STATUS: DRAFT
CREATED: 2025-12-20
VERIFIED: 2025-12-20 against ?
$$$

---

## CHAIN

$$$
PATTERNS:        ./PATTERNS_Connectome_Flow_Canvas_Pannable_Zoomable_Zoned_System_Map_Rendering_Patterns.md
THIS:            BEHAVIORS_Connectome_Flow_Canvas_Readable_Stable_Interaction_Effects.md (you are here)
ALGORITHM:       ./ALGORITHM_Connectome_Flow_Canvas_Layout_Zones_And_Edge_Label_Decluttering.md
VALIDATION:      ./VALIDATION_Connectome_Flow_Canvas_Invariants_For_Readability_And_Stability.md
IMPLEMENTATION:  ./IMPLEMENTATION_Connectome_Flow_Canvas_Code_Structure_With_React_Flow_And_Zones.md
HEALTH:          ./HEALTH_Connectome_Flow_Canvas_Runtime_Verification_Of_Render_Stability_And_Perf_Budgets.md
SYNC:            ./SYNC_Connectome_Flow_Canvas_Sync_Current_State.md
$$$

---

## BEHAVIORS

### B1: Pan/zoom makes dense diagrams inspectable without shrinking labels to noise

$$$
GIVEN:  nodes are spaced further apart and labels remain readable
WHEN:   user pans and zooms
THEN:   user can inspect any node and edge label without losing context
AND:    reset/fit returns them to a known view
$$$

### B2: Zones make the system instantly legible

$$$
GIVEN:  FE/BE/GRAPH/AGENTS zones exist
THEN:   user can immediately identify which area each node belongs to
AND:    edges crossing zones feel meaningful rather than spaghetti
$$$

### B3: Stepper focus never causes edge disappearance

$$$
GIVEN:  user clicks Next repeatedly
THEN:   edges remain rendered and stable
AND:    only focus/glow/pulse changes
$$$

### B4: Hovering provides clarifying remarks without clutter

$$$
GIVEN:  user hovers a node or edge
THEN:   a tooltip displays payload summary, rate, and notes (including “?”)
AND:    the main map remains uncluttered
$$$

### B5: Fit-to-view restores orientation

$$$
GIVEN:  user pans/zooms far away
WHEN:   user clicks “fit”
THEN:   camera returns to a stable view framing the zone containers
$$$

---

## EDGE CASES

### E1: Window resize

$$$
GIVEN:  viewport resizes
THEN:   camera transform remains valid and edges do not vanish
AND:    layout remains stable (no random reflow)
$$$

---

## ANTI-BEHAVIORS

### A1: Force layout jitter in stepper mode

$$$
MUST NOT: nodes move around when stepping (breaks spatial memory)
INSTEAD: layout is deterministic; focus changes are visual only
$$$

### A2: Label overlap as default state

$$$
MUST NOT: edge labels overlap to the point of unreadability at 100% zoom
INSTEAD: label placement rules and spacing prevent collisions by default
$$$

---

## GAPS / IDEAS / QUESTIONS

* QUESTION: should labels fade when zoomed out? (likely yes, but must be predictable)
* IDEA: show only active edge label when zoom < threshold

---

---

### docs/connectome/flow_canvas/ALGORITHM_Connectome_Flow_Canvas_Layout_Zones_And_Edge_Label_Decluttering.md

$$$

# flow_canvas — Algorithm: Zones, Layout, and Label Decluttering

STATUS: DRAFT
CREATED: 2025-12-20
VERIFIED: 2025-12-20 against ?
$$$

---

## CHAIN

$$$
PATTERNS:        ./PATTERNS_Connectome_Flow_Canvas_Pannable_Zoomable_Zoned_System_Map_Rendering_Patterns.md
BEHAVIORS:       ./BEHAVIORS_Connectome_Flow_Canvas_Readable_Stable_Interaction_Effects.md
THIS:            ALGORITHM_Connectome_Flow_Canvas_Layout_Zones_And_Edge_Label_Decluttering.md (you are here)
VALIDATION:      ./VALIDATION_Connectome_Flow_Canvas_Invariants_For_Readability_And_Stability.md
IMPLEMENTATION:  ./IMPLEMENTATION_Connectome_Flow_Canvas_Code_Structure_With_React_Flow_And_Zones.md
HEALTH:          ./HEALTH_Connectome_Flow_Canvas_Runtime_Verification_Of_Render_Stability_And_Perf_Budgets.md
SYNC:            ./SYNC_Connectome_Flow_Canvas_Sync_Current_State.md
$$$

---

## OVERVIEW

The canvas renders a stable projection:

* zones are rectangles with titles
* nodes are positioned inside zones deterministically
* edges route between nodes with stable ids
* label placement is consistent and avoids overlap as much as possible

---

## DATA STRUCTURES

### `ZoneLayout`

$$$
ZoneLayout:
zone_id: FRONTEND|BACKEND|GRAPH|AGENTS
x: number
y: number
width: number
height: number
title: string
$$$

### `NodeLayout`

$$$
NodeLayout:
node_id: string
zone_id: ZoneLayout.zone_id
x: number
y: number
width: number
height: number
$$$

### `EdgeLayout`

$$$
EdgeLayout:
edge_id: string
from_node_id: string
to_node_id: string
label_anchor: {x,y}
route: polyline|bezier (implementation choice)
$$$

---

## ALGORITHM: `compute_zone_layout(viewport)`

V1 deterministic zone coordinates:

$$$
FRONTEND: x=40,  y=40,  w=420, h=520
BACKEND:  x=520, y=40,  w=520, h=720
GRAPH:    x=1080,y=40,  w=420, h=520
AGENTS:   x=1080,y=600, w=420, h=260
$$$

These are tuned for readability and spacing; they scale with viewport.

---

## ALGORITHM: `place_nodes_within_zones(nodes, zones)`

* each node has a preferred slot (row/column)
* spacing constant ensures “nodes more far away”

$$$
slot_spacing_x = 260
slot_spacing_y = 180
node_padding   = 24
$$$

Place nodes by:

* zone_id grouping
* stable ordering by node_id or explicit “pipeline order” list

---

## ALGORITHM: `route_edges_and_place_labels(edges, node_layouts)`

Edge routing choice for v1:

* bezier curves with consistent curvature direction
* label anchored at 55% of curve length
* label background halo provided by edge_kit (render concern)

Label declutter heuristic (v1 minimal, stable):

* if two labels are within radius R, offset the newer one by (+0, +18) repeatedly up to 3 times
* if still colliding: mark `label_visibility="active_only"` when zoomed out (policy)

---

## ALGORITHM: `apply_camera_transform(camera, world_coords)`

* camera: {pan_x, pan_y, zoom}
* world→screen transform applied by rendering library

Must preserve:

* stable edge endpoints at node boundaries
* no viewBox recompute races

---

## COMPLEXITY

* layout compute: O(n + m)
* collision offset: O(m) with small constant factor

---

## GAPS / IDEAS / QUESTIONS

* IDEA: use dagre layout for v2 but pin main pipeline nodes
* QUESTION: do we allow user to drag nodes? (v1: no, to preserve determinism)

---

---

### docs/connectome/flow_canvas/VALIDATION_Connectome_Flow_Canvas_Invariants_For_Readability_And_Stability.md

$$$

# flow_canvas — Validation: Invariants for Readability and Render Stability

STATUS: DRAFT
CREATED: 2025-12-20
VERIFIED: 2025-12-20 against ?
$$$

---

## CHAIN

$$$
PATTERNS:        ./PATTERNS_Connectome_Flow_Canvas_Pannable_Zoomable_Zoned_System_Map_Rendering_Patterns.md
BEHAVIORS:       ./BEHAVIORS_Connectome_Flow_Canvas_Readable_Stable_Interaction_Effects.md
ALGORITHM:       ./ALGORITHM_Connectome_Flow_Canvas_Layout_Zones_And_Edge_Label_Decluttering.md
THIS:            VALIDATION_Connectome_Flow_Canvas_Invariants_For_Readability_And_Stability.md (you are here)
IMPLEMENTATION:  ./IMPLEMENTATION_Connectome_Flow_Canvas_Code_Structure_With_React_Flow_And_Zones.md
HEALTH:          ./HEALTH_Connectome_Flow_Canvas_Runtime_Verification_Of_Render_Stability_And_Perf_Budgets.md
SYNC:            ./SYNC_Connectome_Flow_Canvas_Sync_Current_State.md
$$$

---

## INVARIANTS

### V1: Pan/zoom always keeps nodes and edges coherent

$$$
When camera changes:
node positions update consistently
edge endpoints remain attached (no drifting)
no edges disappear
$$$

### V2: Deterministic layout under stepper changes

$$$
Given identical node list and zone layout:
node positions do not change when stepping
only styling changes (active focus)
$$$

### V3: Label readability at 100% zoom

$$$
At zoom=1.0:
label font size >= minimum readable threshold (>=12px)
labels do not overlap more than acceptable threshold (policy)
$$$

### V4: Zones render behind nodes and edges consistently

$$$
Zones do not occlude edges and labels
Zones remain visible as grouping structure
$$$

---

## ERROR CONDITIONS

### E1: Edge vanishes during step transition

* severity: ERROR
* meaning: canvas render stability is broken (unacceptable for debugging)

### E2: Label collisions make data unreadable

* severity: WARN
* meaning: declutter policy needs improvement or node spacing too tight

---

## HEALTH COVERAGE

| Validation | Health Indicator                                |
| ---------- | ----------------------------------------------- |
| V1         | canvas_edge_attachment_and_visibility_integrity |
| V2         | canvas_layout_determinism_integrity             |
| V3         | canvas_label_readability_sampling               |
| E1         | canvas_edge_disappearance_detector              |

---

## VERIFICATION PROCEDURE

### Manual

$$$
[ ] Step repeatedly → no edges disappear
[ ] Resize window → no edges disappear
[ ] Zoom in/out → labels remain readable at zoom=1.0
[ ] Fit-to-view → zones frame correctly
$$$

### Automated (conceptual)

$$$
pnpm connectome:health flow_canvas
$$$

---

## GAPS / IDEAS / QUESTIONS

* QUESTION: define measurable label overlap threshold for v1 health checks (pixel-based sampling?).

---

---

### docs/connectome/flow_canvas/HEALTH_Connectome_Flow_Canvas_Runtime_Verification_Of_Render_Stability_And_Perf_Budgets.md

$$$

# flow_canvas — Health: Render Stability and Performance Budget Checks

STATUS: DRAFT
CREATED: 2025-12-20
$$$

---

## PURPOSE OF THIS FILE

This HEALTH file ensures the canvas remains a usable diagnostic tool as the diagram grows:

* no disappearing edges
* layout determinism under stepping
* basic performance budgets (frame time and rerender counts) (lightweight)

It does not validate aesthetics in detail (colors/glows are edge_kit/node_kit).

---

## CHAIN

$$$
PATTERNS:        ./PATTERNS_Connectome_Flow_Canvas_Pannable_Zoomable_Zoned_System_Map_Rendering_Patterns.md
BEHAVIORS:       ./BEHAVIORS_Connectome_Flow_Canvas_Readable_Stable_Interaction_Effects.md
ALGORITHM:       ./ALGORITHM_Connectome_Flow_Canvas_Layout_Zones_And_Edge_Label_Decluttering.md
VALIDATION:      ./VALIDATION_Connectome_Flow_Canvas_Invariants_For_Readability_And_Stability.md
IMPLEMENTATION:  ./IMPLEMENTATION_Connectome_Flow_Canvas_Code_Structure_With_React_Flow_And_Zones.md
THIS:            HEALTH_Connectome_Flow_Canvas_Runtime_Verification_Of_Render_Stability_And_Perf_Budgets.md
SYNC:            ./SYNC_Connectome_Flow_Canvas_Sync_Current_State.md

IMPL:            ? (planned) scripts/connectome/health/flow_canvas_health_check_runner.ts
$$$

---

## FLOWS ANALYSIS (TRIGGERS + FREQUENCY)

$$$
flows_analysis:

* flow_id: canvas_stepper_render_updates
  purpose: ensure stepping never hides edges
  triggers:

  * type: manual
    source: runtime_engine Next click
    frequency:
    expected_rate: "human driven"
    peak_rate: "rapid clicking"
    risks:
  * "edge disappearance"
  * "layout jitter"
  * "label collisions"
    notes: "edge disappearance is the primary v1 failure"

* flow_id: canvas_camera_changes
  purpose: ensure pan/zoom never detaches edges
  triggers:

  * type: manual
    source: pan/zoom gestures + fit-to-view
    frequency:
    expected_rate: "frequent during use"
    risks:
  * "edge endpoint drift"
  * "label misplacement"
    $$$

---

## HEALTH INDICATORS SELECTED

$$$
health_indicators:

* name: canvas_edge_disappearance_detector
  flow_id: canvas_stepper_render_updates
  priority: high
  rationale: "If edges vanish, the instrument is broken."

* name: canvas_layout_determinism_integrity
  flow_id: canvas_stepper_render_updates
  priority: high
  rationale: "No node jitter during stepping."

* name: canvas_edge_attachment_and_visibility_integrity
  flow_id: canvas_camera_changes
  priority: high
  rationale: "Pan/zoom must not break attachment."
  $$$

---

## CHECKER INDEX

$$$
checkers:

* name: health_check_edges_present_after_each_step
  purpose: "After each step release, assert all expected edge ids are still rendered."
  status: pending
  priority: high

* name: health_check_node_positions_stable_under_stepper
  purpose: "Assert node positions unchanged while stepping."
  status: pending
  priority: high

* name: health_check_edge_endpoints_attach_to_node_bounds
  purpose: "Sample endpoints and assert they are within tolerance of node bounds."
  status: pending
  priority: high
  $$$

---

## HOW TO RUN

$$$
pnpm connectome:health flow_canvas
$$$

---

## KNOWN GAPS

* [ ] requires an implementation-level probe to detect “rendered edges” (React Flow hook or test harness)
* [ ] label overlap measurement not defined yet

---

## GAPS / IDEAS / QUESTIONS

* IDEA: instrument render counts per step and warn if too many rerenders
* QUESTION: do we define a frame budget threshold now (e.g., 16ms) or defer?

---

---

### docs/connectome/flow_canvas/SYNC_Connectome_Flow_Canvas_Sync_Current_State.md

$$$

# flow_canvas — Sync: Current State

LAST_UPDATED: 2025-12-20
UPDATED_BY: Marco "Salthand" (agent)
STATUS: DESIGNING
$$$

---

## MATURITY

**Canonical (v1 intent):**

* pannable/zoomable system map
* zones FE/BE/GRAPH/AGENTS
* deterministic layout
* stable edge rendering (no disappearance)

**In design:**

* label declutter heuristic thresholds
* minimap and drag behavior (likely defer)

**Deferred:**

* force layout exploration mode (separate view)

---

## CURRENT STATE

Docs defined; no implementation yet. This module exists because manual SVG edge rendering caused readability and stability failures. The plan is to use a stable canvas framework (e.g., React Flow) with deterministic positions and stable keyed elements.

---

## RECENT CHANGES

### 2025-12-20: Initialized flow_canvas chain docs

* added zones and camera behaviors
* specified deterministic layout and label decluttering

---

## TODO

* [ ] Implement FlowCanvas with pan/zoom and zones
* [ ] Implement stable node layout positions with wide spacing
* [ ] Implement stable edge label placement with minimal declutter
* [ ] Add flow_canvas health harness to detect edge disappearance

Run:

$$$
pnpm connectome:health flow_canvas
$$$

---

## HANDOFF

**For agents:**

* Do not implement force layout in v1 main view
* Ensure edges are keyed and never re-created with new ids on each render

**For human:**

* Decide whether to allow node dragging in v1 (recommended: no)

---

---

### docs/connectome/flow_canvas/IMPLEMENTATION_Connectome_Flow_Canvas_Code_Structure_With_React_Flow_And_Zones.md

$$$

# flow_canvas — Implementation: Code Architecture and Structure

STATUS: DRAFT
CREATED: 2025-12-20
$$$

---

## CHAIN

$$$
PATTERNS:        ./PATTERNS_Connectome_Flow_Canvas_Pannable_Zoomable_Zoned_System_Map_Rendering_Patterns.md
BEHAVIORS:       ./BEHAVIORS_Connectome_Flow_Canvas_Readable_Stable_Interaction_Effects.md
ALGORITHM:       ./ALGORITHM_Connectome_Flow_Canvas_Layout_Zones_And_Edge_Label_Decluttering.md
VALIDATION:      ./VALIDATION_Connectome_Flow_Canvas_Invariants_For_Readability_And_Stability.md
THIS:            IMPLEMENTATION_Connectome_Flow_Canvas_Code_Structure_With_React_Flow_And_Zones.md
HEALTH:          ./HEALTH_Connectome_Flow_Canvas_Runtime_Verification_Of_Render_Stability_And_Perf_Budgets.md
SYNC:            ./SYNC_Connectome_Flow_Canvas_Sync_Current_State.md

IMPL:            app/connectome/components/pannable_zoomable_zoned_flow_canvas_renderer.tsx (PROPOSED)
$$$

---

## CODE STRUCTURE

$$$
app/
└── connectome/
├── components/
│   ├── pannable_zoomable_zoned_flow_canvas_renderer.tsx
│   ├── deterministic_zone_and_node_layout_computation_helpers.ts
│   └── edge_label_declutter_and_visibility_policy_helpers.ts
$$$

### File Responsibilities

| File                                                        | Responsibility                              | Key Components/Exports                   |
| ----------------------------------------------------------- | ------------------------------------------- | ---------------------------------------- |
| `pannable_zoomable_zoned_flow_canvas_renderer.tsx`          | renders zones + nodes + edges with pan/zoom | `FlowCanvas`                             |
| `deterministic_zone_and_node_layout_computation_helpers.ts` | compute positions from node list            | `computeZones`, `computeNodePositions`   |
| `edge_label_declutter_and_visibility_policy_helpers.ts`     | label placement offsets and zoom policy     | `computeLabelAnchors`, `shouldShowLabel` |

---

## DESIGN PATTERNS

* stable keyed elements (ids never change)
* deterministic layout (no force)
* camera controls: fit/reset/pan/zoom

---

## ENTRY POINTS

| Entry Point                                 | Trigger                                   |
| ------------------------------------------- | ----------------------------------------- |
| `FlowCanvas()`                              | /connectome page render                   |
| `computeZones(viewport)`                    | on init and on resize                     |
| `computeNodePositions(nodes, zones)`        | on node list change (not on focus change) |
| `computeLabelAnchors(edges, nodePositions)` | on edge list change                       |

---

## DATA FLOW AND DOCKING

### store_projection_to_canvas

$$$
flow:
name: store_projection_to_canvas
steps:
- read node list + edge list + active focus from store
- compute positions (only when topology changes)
- render FlowCanvas with edge_kit and node_kit components
docking_points:
- dock_canvas_rendered_edge_ids (metric): used by HEALTH to detect missing edges
$$$

---

## CONFIGURATION

| Config            | Default    |
| ----------------- | ---------- |
| `NODE_SPACING_X`  | 260        |
| `NODE_SPACING_Y`  | 180        |
| `LABEL_MIN_ZOOM`  | 0.8 (?)    |
| `ALLOW_NODE_DRAG` | false (v1) |

---

## BIDIRECTIONAL LINKS

* canvas TSX should reference this doc chain
* health harness should reference VALIDATION invariants

---

## GAPS / IDEAS / QUESTIONS

* QUESTION: adopt React Flow as dependency (recommended) or implement custom canvas? (v1: React Flow)
* IDEA: minimap toggle in top-right for navigation
