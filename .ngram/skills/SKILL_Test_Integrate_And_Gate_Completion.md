# Skill: `ngram.test_integrate_and_gate`
@ngram:id: SKILL.TEST.INTEGRATE.GATE_COMPLETION

## Maps to VIEW
`.ngram/views/VIEW_Implement_Write_Or_Modify_Code.md`

## Purpose
Define unit/integration tests mapped to VALIDATION invariants; gate module completion on all tests passing.

---

## Core Principle

**Tests gate completion. Health monitors runtime.**

| Concern | Tests (CI) | Health (Runtime) |
|---------|------------|------------------|
| When | Build time | Production |
| Data | Fixtures | Real graph |
| Catches | Code bugs | Emergent drift |
| Blocks | Merge/deploy | Alerts/pages |

---

## Bidirectional Link Pattern

Two-point link only. IMPLEMENTATION not involved.

```
VALIDATION ──────────────────────> Test File
  verified_by:                       @validates:
    test: file::function             @ngram:id
    confidence: high                 @see: VALIDATION path
```

### VALIDATION → Test

```yaml
### @ngram:id: V-ENERGY-NON-NEGATIVE
invariant: All energy values >= 0
priority: HIGH
verified_by:
  test: tests/physics/test_energy.py::test_draw_clamps_to_available
  health: engine/physics/health/no_negative.py::check
  confidence: high  # high | partial | needs-health | untested
```

### Test → VALIDATION

```python
"""
@validates: V-ENERGY-NON-NEGATIVE, V-MOMENT-DRAW-BOUNDS
@see: docs/physics/VALIDATION_Energy_Physics.md#v-energy-non-negative
"""
def test_draw_clamps_to_available():
    ...
```

---

## Confidence Levels

| Level | Meaning |
|-------|---------|
| `high` | Test + health cover completely |
| `partial` | Test exists but edge cases remain |
| `needs-health` | Runtime behavior matters more than test |
| `untested` | Gap, tracked for completion |

---

## Inputs (YAML)

```yaml
module: "<area/module>"
invariants: ["<VALIDATION @ngram:id anchors>"]
```

---

## Outputs (YAML)

```yaml
test_mapping:
  - invariant_id: "<V-*>"
    test: "<file::function>"
    health: "<file::function>"
    confidence: "<high|partial|needs-health|untested>"

completion_gate:
  module: "<module name>"
  status: "<complete|incomplete|blocked>"
  blocking_tests: ["<test names if any fail>"]
```

---

## Gates (Non-Negotiable)

1. **Every HIGH priority invariant must have `verified_by.test:` or `verified_by.health:`**
2. **Tests must have `@validates:` and `@see:` docstrings**
3. **Module is INCOMPLETE if any mapped test fails**
4. **Completion status must be machine-readable**

---

## Test Selection Criteria

### Include in Tests

| Category | Why |
|----------|-----|
| Formula correctness | Deterministic input → output |
| State transitions | Finite, enumerable |
| Bounds checking | Known edge cases |
| Ordering invariants | Sequence matters |

### Exclude from Tests (Health Only)

| Category | Why |
|----------|-----|
| Drift over time | Needs 1000+ real ticks |
| Ratio health | Emergent behavior |
| Graph-wide state | Needs real structure |

---

## File Structure

```
tests/
└── {area}/
    └── test_{module}.py          # @validates: docstrings

docs/{area}/{module}/
├── VALIDATION_{module}.md        # verified_by: fields
└── HEALTH_{module}.md            # Runtime checkers

.ngram/
└── completion/
    └── {module}_gate.yaml        # Machine-readable status
```

---

## Test File Template

```python
"""
@validates: V-TICK-ORDER, V-MOMENT-TRANSITIONS
@see: docs/physics/VALIDATION_Energy_Physics.md
"""
import pytest


class TestTickExecution:
    """
    @validates: V-TICK-ORDER
    @see: docs/physics/VALIDATION_Energy_Physics.md#v-tick-order
    """

    def test_phases_in_order(self):
        """Phases execute 1→2→3→4→5→6"""
        tick = GraphTick(...)
        result = tick.run()
        timestamps = result.phase_timestamps
        assert timestamps[0] < timestamps[1] < timestamps[2]


class TestLinkPhysics:
    """
    @validates: V-LINK-STRENGTH-GROWTH
    @see: docs/physics/VALIDATION_Energy_Physics.md#v-link-strength-growth
    """

    def test_strength_formula(self):
        """growth = (amount × emotion × origin.weight) / ((1+strength) × target.weight)"""
        link = Link(strength=0.5)
        origin = Actor(weight=2.0)
        target = Actor(weight=1.5)

        energy_flows_through(link, amount=0.3, emotion_intensity=0.7, origin=origin, target=target)

        expected = 0.5 + (0.3 * 0.7 * 2.0) / ((1 + 0.5) * 1.5)
        assert link.strength == pytest.approx(expected, rel=0.01)
```

---

## Completion Gate Schema

File: `.ngram/completion/{module}_gate.yaml`

```yaml
# Auto-generated by test runner. Do not edit manually.
module: energy_physics
version: v1.2
generated_at: 2024-12-23T15:30:00Z

# Completion status
status: incomplete  # complete | incomplete | blocked

# Test results
tests:
  total: 5
  passed: 4
  failed: 1
  skipped: 0

# Blocking tests (if any)
blocking:
  - test: test_radiation_rate_matches_duration
    invariant: V-MOMENT-DURATION-RATE
    error: "AssertionError: 0.17 != 0.2"
    file: tests/physics/test_energy_v1.2.py:89

# Passing tests
passing:
  - test: test_phases_in_order
    invariant: V-TICK-ORDER
  - test: test_valid_transitions_only
    invariant: V-MOMENT-TRANSITIONS
  - test: test_strength_formula
    invariant: V-LINK-STRENGTH-GROWTH
  - test: test_draw_clamps_to_available
    invariant: V-MOMENT-DRAW-BOUNDS

# Health status (informational, doesn't gate)
health:
  status: ok  # ok | warn | error
  checkers_passing: 3
  checkers_total: 3
```

---

## CI Integration

```yaml
# .github/workflows/test.yml
- name: Run tests
  run: pytest tests/ -v --tb=short

- name: Generate completion gate
  run: python -m ngram.gate generate

- name: Check completion gate
  run: |
    python -m ngram.gate check
    # Exits 1 if any module is incomplete
    # Blocks PR merge
```

---

## Workflow

1. **VALIDATION** — Add `verified_by:` with `confidence:` for each invariant
2. **Test file** — Add `@validates:` and `@see:` docstrings
3. **Run tests** → generates completion gate
4. **Gate check** → blocks merge if incomplete

---

## Markers

- `@ngram:todo <missing test for invariant>`
- `@ngram:escalation <test blocked by infrastructure>`
- `@ngram:proposition <test improvement>`

---

## Never-Stop Rule

If blocked, log `@ngram:escalation`, set `confidence: blocked` in VALIDATION, continue to next task.
